<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>1</title>
	<script type="text/javascript">

		document.addEventListener('plusready', function () {
			//console.log("所有plus api都应该在此事件发生后调用，否则会出现plus is undefined。")

		});

	</script>
	<style>
		#zuozhe {
			color: #00aafe;
			text-decoration: none;
		}

		#xiaoliang {
			color: #fe0000;
		}
	</style>
</head>

<body>
	<div>图片下载器</div>
	<a id="zuozhe" href="https://space.bilibili.com/353403349">作者bilibili@你看清楚了吗</a>
	<br><br>
	<input type="text" id="gjc" placeholder="输入收藏集的名称搜索" style="width:200px">
	<!-- <button id="search">搜索</button> -->
	<br><br>
	<select id="mySelect" style="width:200px"></select>
	<br>
	<!-- <div id="jieguo">选择好了就按下面的开始</div> -->
	<div id="xiaoliang">销量：</div>
	<input type="number" id="websiteInput" placeholder="名称搜索不到?直接输入actid" style="width:200px">
	<button id="start">开始</button>
	<br><br>
	<!-- <textarea id="contentDisplay" rows="10" cols="50" readonly></textarea> -->

	<div id="zong"></div>

	<script>
		let windowWidth = window.innerWidth || document.documentElement.clientWidth;
		//console.log('窗口宽度为：' + windowWidth + '像素');

		const suoyinweb = 'https://api.bilibili.com/x/garb/card/subject/list?subject_id=42'
		//const suoyinweb = 'http://127.0.0.1:5500/42.txt'
		let select = document.getElementById('mySelect');
		select.innerHTML = ''
		let option1 = new Option('点击选择', '-1');
		select.add(option1);
		let input = document.getElementById('websiteInput')
		input.value = ''
		let xiaoliang = document.getElementById('xiaoliang')
			

		let suoyin = ''
		fetch(suoyinweb)
			.then(response => response.json())
			.then(content => {
				suoyin = content;
				for (let i = 0; i < suoyin.data.subject_card_list.length; i++) {
					let actname = suoyin.data.subject_card_list[i].act_name
					let num = Number(suoyin.data.subject_card_list[i].act_id)
					let option1 = new Option(actname, num);
					select.add(option1);
				}
			})




		const inputElement = document.getElementById('gjc');
		inputElement.addEventListener('input', function () {
			//console.log('输入值有变化！');
			select.innerHTML = ''
			console.log(JSON.stringify(suoyin))
			xiaoliang.innerHTML='销量：'

			input.value = ''
			let option1 = new Option('点击选择', '-1');
			select.add(option1);
			for (let i = 0; i < suoyin.data.subject_card_list.length; i++) {
				let actname = suoyin.data.subject_card_list[i].act_name
				let num = Number(suoyin.data.subject_card_list[i].act_id)
				let gj = document.getElementById("gjc").value
				if (actname.match(gj)) {
					let option1 = new Option(actname, num);
					select.add(option1);
				}
			}
		});
		select.addEventListener('change', function () {
			var selectedIndex = this.selectedIndex;
			var selectedValue = this.options[selectedIndex].value;
			var selectedText = this.options[selectedIndex].text;

			console.log('新选中项的索引:', selectedIndex);
			console.log('新选中项的值:', selectedValue);
			console.log('新选中项的文本:', selectedText);

			input.value = selectedValue != '-1' ? Number(selectedValue) : ''
			fetchWebsiteContent()
		});
		function fetchWebsiteContent() {
			const websiteUrl = 'https://api.bilibili.com/x/vas/dlc_act/act/item/list?act_id=' + document.getElementById("websiteInput").value + '&ruid=1425239276&uid=0';
			//const websiteUrl = 'http://127.0.0.1:5500/101545.txt'
			console.log(websiteUrl);

			let xiao = 0
			let gailv = ''
			fetch(websiteUrl)
				.then(response => response.json())
				.then(content => {
					const tag = document.getElementById('zong');
					tag.remove();
					let div1 = document.createElement('div');
					div1.style.display = "flex"
					//div1.style.flexWrap = 'wrap'
					div1.style.flexDirection = 'column'
					div1.id = 'zong'
					document.body.appendChild(div1);
					for (let i = 0; i < content.data.item_list.length; i++) {

						let Container = document.createElement('div')
						//Container.style.flexFlow = 'row nowrap'
						Container.id = 'Container'
						Container.style.display = "flex"
						Container.style.flexDirection = 'row'
						div1.appendChild(Container);
						let imageContainer = document.createElement('div')
						//imageContainer.style.flex = '0 0 15%'
						//imageContainer.style.flexDirection = 'row'
						imageContainer.id = 'imageContainer'
						Container.appendChild(imageContainer);
						let buttonContainer = document.createElement('div')
						//buttonContainer.style.flex = '0 0 60%'
						//buttonContainer.style.flexDirection = 'row'
						buttonContainer.id = 'buttonContainer'
						buttonContainer.style.margin = 'auto auto'
						buttonContainer.style.display = "flex"
						buttonContainer.style.flexDirection = 'column'
						//buttonContainer.style.marginLeft = 'auto'
						//buttonContainer.style.marginRight = 'auto'

						Container.appendChild(buttonContainer);
						let brr1 = document.createElement('br');
						Container.appendChild(brr1);

						let img = document.createElement('img');
						img.id = 'img1' + String(i)
						img.src = String(content.data.item_list[i].card_item.card_img) + '@150w.webp'
						img.style.width = String(Number(windowWidth) / 2 - 15) + 'px'
						img.style.flex = 1
						imageContainer.appendChild(img);

						let AButton1 = document.createElement('a');
						AButton1.id = 'a1' + String(i)
						AButton1.href = String(content.data.item_list[i].card_item.card_img);
						AButton1.download = "bilibili_avatar.png"
						let cardname = document.createElement('div');
						cardname.style.textAlign = 'center'
						let gailvdiv = document.createElement('div')
						gailvdiv.style.textAlign = 'center'
						if (String(content.data.item_list[i].card_item.holding_rate) != 0) {
							xiao = xiao + Number(content.data.item_list[i].card_item.total_cnt)
							gailv = Number(content.data.item_list[i].card_item.holding_rate) / 100 + '%'
						}
						else {
							gailv = ''
						}
						cardname.innerHTML = String(content.data.item_list[i].card_item.card_name) + "<br>" + String(content.data.item_list[i].card_item.card_ext_text);
						gailvdiv.innerHTML = gailv
						gailvdiv.style.color = '#ff000f'
						let BButton1 = document.createElement('button');
						BButton1.innerHTML = "下载图片"
						BButton1.style.width = String(Number(windowWidth) / 2 - 15) + 'px'
						BButton1.style.height = '50px'
						AButton1.appendChild(BButton1)
						buttonContainer.appendChild(cardname);
						buttonContainer.appendChild(gailvdiv);
						buttonContainer.appendChild(AButton1);

						if (content.data.item_list[i].card_item.video_list != null) {
							let AButton2 = document.createElement('a');
							AButton2.id = 'a2' + String(i)
							AButton2.href = String(content.data.item_list[i].card_item.video_list[0]);
							AButton2.download = "bilibili_avatar.mp4"
							let BButton2 = document.createElement('button');
							BButton2.innerHTML = "下载视频"
							BButton2.style.width = String(Number(windowWidth) / 2 - 15) + 'px'
							BButton2.style.height = '50px'
							BButton2.style.backgroundColor = 'rgb(0,0,0,0.39)'
							BButton2.style.color = '#fff'
							BButton2.style.border = 'none';
							AButton2.appendChild(BButton2)
							buttonContainer.appendChild(AButton2);
						}



					}
					xiaoliang.innerHTML = String('销量：' + xiao)
				})

		}
		// var ButtonSearch = document.getElementById("search");
		// ButtonSearch.addEventListener("click", function () {
		// 	sousuo()
		// 	console.log("按钮搜索已经被点击");

		// });
		var ButtonStart = document.getElementById("start");
		ButtonStart.addEventListener("click", function () {
			fetchWebsiteContent()
			console.log("按钮开始已经被点击");

		});




	</script>
</body>

</html>
